name: End-to-End Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils traceroute openssl
          pip install .

      - name: Run Diagnostics on Example.com
        run: |
          cfdiag example.com --json

      - name: Run Diagnostics on Cloudflare.com (IPv4 forced)
        run: |
          cfdiag cloudflare.com --ipv4

      - name: Verify JSON Output
        run: |
          cfdiag example.com --json > output.json
          if ! grep -q "http_status" output.json; then
            echo "JSON output missing keys"
            exit 1
          fi
